# 割り勘（Settlement）仕様 — 強い10項目

> 最終更新: 2026-02-08
> ステータス: Draft v1（レビュー待ち）

本ドキュメントは割り勘機能の設計判断を10項目に絞り、各項目を **決定事項 / 理由 / 例** の3段で記載する。
MVP（Phase 1）で実装する範囲と Phase 2 以降に先送りする境界を明確にすることが目的。

---

## (1) 分割方法

| | |
|---|---|
| **決定** | MVP では **均等割り (equal)** と **個別金額指定 (fixed)** の2種を提供する。割合 (%) による分割は Phase 2。 |
| **理由** | 均等割りがユースケースの大半を占める。個別金額を許容すれば「Aだけ多く払う」にも対応できる。割合は端数処理が複雑になるため後回し。 |
| **例** | ¥3,000 のランチを3人で均等 → 各 ¥1,000。¥5,000 を A=¥2,000 / B=¥1,500 / C=¥1,500 で fixed。 |

## (2) 端数処理（1円単位）

| | |
|---|---|
| **決定** | `floor` で各人に割り当て、余りは **支払者 (payer)** に寄せる。結果は決定的（同じ入力→同じ出力）。 |
| **理由** | 検算が容易。再計算しても結果がぶれない。payer に寄せるのは「立て替えた人が端数を負担する」という直感に合致。 |
| **例** | ¥10,001 を3人で均等 → floor(10001/3) = ¥3,333 × 3 = ¥9,999。余り ¥2 は payer の負担分に加算 → payer: ¥3,335, 他2人: ¥3,333。 |

## (3) 編集/取消の扱い（監査・整合性の核）

| | |
|---|---|
| **決定** | **上書き禁止**。取消は `void` + 置換は `replace`（新しい expense を作成しリンク）で履歴を残す。 |
| **理由** | 台帳が壊れない。void/replace のリンクにより「何が→何に変わったか」が追跡可能。監査ログが成立する。 |
| **例** | expense#42 を修正したい → expense#42 を void（status=void, replaced_by=43）→ expense#43 を新規作成（replaces=42）。 |

## (4) 計算結果の保存方針

| | |
|---|---|
| **決定** | 残高 (balances) と精算提案 (suggestions) は **派生データとして都度再計算**する。DB にキャッシュしない。 |
| **理由** | void/replace で過去データが変わっても再計算で常に正しい結果が得られる。キャッシュ不整合事故がゼロ。 |
| **例** | GET /balances → active な expense + shares から集計して返す。void 済みは除外。 |

## (5) 精算提案（最小送金回数）

| | |
|---|---|
| **決定** | 提案は **表示のみ**（確定・実行は Phase 2）。アルゴリズムは貪欲法 (greedy) で十分。 |
| **理由** | 確定/支払い記録までやると仕様が重くなる。まず「誰が誰にいくら払えばよいか」を見せて信用の土台を作る。 |
| **例** | A: +¥2,000, B: -¥1,200, C: -¥800 → 提案: B→A ¥1,200, C→A ¥800（2件の送金で完了）。 |

## (6) 支払い記録 (Payment)

| | |
|---|---|
| **決定** | MVP では **提案表示のみ**。支払い記録テーブル (`circle_settlement_payments`) は Phase 2。 |
| **理由** | 支払い記録は「誰が本当に送金したか」の確認フローが必要で、MVP スコープを超える。 |
| **例** | 画面に「BさんはAさんに¥1,200を送金してください」と表示。PayPay等の外部リンク/メモは note フィールドで代用可。 |

## (7) 権限 (RBAC)

| | |
|---|---|
| **決定** | **Plus プランの circle** でのみ利用可能。expense の作成・取消・置換は **owner / admin** のみ。member は閲覧のみ。 |
| **理由** | 金銭に関わる操作は管理者に限定し、誤操作・悪意のリスクを最小化。Plan gate は既存の仕組みを流用。 |
| **例** | member が POST /expenses → 403。admin が POST /expenses → 201。member が GET /balances → 200（閲覧OK）。 |

## (8) メンバー脱退/削除

| | |
|---|---|
| **決定** | 過去の expense/share データは保持する。表示名は作成時点のスナップショット (`member_snapshot_name`) を share に持つ。 |
| **理由** | 退会後も精算履歴が壊れない。「当時の名前」で表示できる。 |
| **例** | メンバー「田中」が退会 → 過去の share には member_snapshot_name="田中" が残り、残高計算にも含まれる。 |

## (9) 通貨・税

| | |
|---|---|
| **決定** | **JPY 固定**。税・為替の計算なし。金額は整数（円）。 |
| **理由** | プロダクトスコープの管理。小数点・為替レートは事故率が高く、ユーザーの大半は国内利用。 |
| **例** | amount_yen: 3000（整数）。外貨対応が必要になったら amount + currency カラムを追加する Phase 2 設計。 |

## (10) 添付（レシート画像）

| | |
|---|---|
| **決定** | MVP では **なし**。Phase 2 で `circle_settlement_expense_attachments` テーブルを追加（既存の media 基盤があれば流用）。 |
| **理由** | 画像アップロードは権限・削除・容量管理が重く、MVP のスコープに含めると肥大化する。 |
| **例** | MVP では expense.note に「レシートはLINEグループ参照」等のテキストで代用。 |

---

## Phase 境界まとめ

| Phase | 含む | 含まない |
|-------|------|----------|
| **MVP (Phase 1)** | 均等/fixed分割, floor端数, void/replace, 再計算balances/suggestions, RBAC, スナップショット名, JPY固定 | 割合分割, 支払い記録, 添付画像, 外貨 |
| **Phase 2** | 割合分割, payments テーブル, 添付画像, 提案の確定フロー | 外貨・税, 外部決済連携 |
